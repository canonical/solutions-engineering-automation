name: Weekly Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * SAT"

jobs:
  weekle-tests:
    name: Run weekly tests
    runs-on: ubuntu-latest
    timeout-minutes: 1440
    outputs:
      failed_tests: ${{ steps.collect-failed-tests.outputs.failed_tests }}
    strategy:
      matrix:
        max-parallel: 3
        include:
          - charm: charm-advanced-routing
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-apt-mirror
            workflow_file_name: check.yaml
            branch: main
          - charm: charm-cloudsupport
            workflow_file_name: check.yaml
            branch: main
          - charm: charm-duplicity
            workflow_file_name: check.yaml
            branch: master
          - charm: hardware-observer-operator
            workflow_file_name: check.yaml
            branch: master
          - charm: hardware-observer-operator-integration
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-juju-backup-all
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-juju-local
            workflow_file_name: check.yaml
            branch: main
          - charm: charm-kubernetes-service-checks
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-local-users
            workflow_file_name: check.yaml
            branch: main
          - charm: charm-logrotated
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-nginx
            workflow_file_name: check.yaml
            branch: main
          - charm: charm-openstack-service-checks
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-prometheus-blackbox-exporter
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-prometheus-libvirt-exporter
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-simple-streams
            workflow_file_name: check.yaml
            branch: main
          - charm: charm-storage-connector
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-sysconfig
            workflow_file_name: check.yaml
            branch: master
          - charm: charm-userdir-ldap
            workflow_file_name: check.yaml
            branch: master
          - charm: prometheus-hardware-exporter
            workflow_file_name: check.yaml
            branch: main
          - charm: prometheus-juju-exporter
            workflow_file_name: pr.yaml
            branch: main
          - charm: prometheus-juju-backup-all-exporter
            workflow_file_name: pr.yaml
            branch: main
          - charm: snap-tempest
            workflow_file_name: pr.yaml
            branch: main
          - charm: charmed-openstack-upgrader
            workflow_file_name: check.yaml
            branch: main

    steps:
      - name: Tests for ${{ matrix.charm }}
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        id: dispatched-tests
        with:
          owner: canonical
          repo: ${{ matrix.charm }}
          github_token: ${{ secrets.GHA_WORKFLOW_TRIGGER }}
          workflow_file_name: ${{ matrix.workflow_file_name }}
          ref: ${{ matrix.branch }}
          wait_interval: 60

      - name: Collect failed tests
        id: collect-failed-tests
        if: ${{ failure() }}
        run: |
          failed_tests=""
          if [ "${{ steps.dispatched-tests.outcome }}" != "success" ]; then
            failed_tests+="[${{ matrix.charm }}](https://github.com/canonical/${{ matrix.charm }}/actions), "
          fi
          # Set the output variable to pass the failed tests to the next job
          echo "failed_tests=$failed_tests" >> "$GITHUB_OUTPUT"

  notify-on-failure:
    needs: [tests-1, tests-2]
    if: ${{ failure() }}
    name: Notify Mattermost Channel
    runs-on: ubuntu-latest
    steps:
      - name: Create the Mattermost Message
        env:
          FAILED_TESTS_1: ${{ needs.tests-1.outputs.failed_tests }}
          FAILED_TESTS_2: ${{ needs.tests-2.outputs.failed_tests }}
        run: |
          echo "{\"text\":\":robot_face: Weekly tests have failed for these projects: $FAILED_TESTS_1 $FAILED_TESTS_2\"}" > mattermost.json

      - uses: mattermost/action-mattermost-notify@master
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
